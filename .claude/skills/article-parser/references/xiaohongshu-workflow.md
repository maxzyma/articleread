# 小红书提取工作流

## 核心原则

**小红书是图片/视频平台，提取成本高。**

完整流程（搜索策略见 SKILL.md）：
1. 访问小红书页面 → **只提取元信息**（标题、作者、发布时间）
2. 用元信息搜索文字平台（详见 SKILL.md 搜索技巧）
3. **只有完全搜索不到**，才回到小红书使用 OCR 提取

---

## 第一步：提取元信息

### 1.1 访问小红书页面

**方法 A：通过搜索访问（推荐）**

用户提供的小红书链接可能被封锁，通过首页搜索访问更稳定：

```bash
# 步骤 1：访问小红书首页
navigate_page -> https://www.xiaohongshu.com/

# 步骤 2：使用搜索框搜索
fill -> 搜索框
value: "<用户提供的作者名或标题关键词>"

# 步骤 3：按 Enter 执行搜索
press_key -> "Enter"

# 步骤 4：从搜索结果中点击目标文章
click -> <文章标题链接>
```

**方法 B：直接访问链接**

如果用户提供的链接可以直接访问：
```bash
navigate_page -> <用户提供的小红书URL>
```

### 1.2 从页面提取元信息

访问成功后，使用 `take_snapshot` 获取页面内容，提取：

| 信息 | 页面位置 | 示例 |
|------|----------|------|
| **标题** | 文章标题区域 | "Claude Code如何让工程师效率暴涨70%？" |
| **作者** | 作者名称链接 | "sqb的Ai学习笔记" |
| **发布时间** | 时间戳 | "2025-12-23" |
| **标签** | #标签区域 | "#AI #AI编程 #Claude" |

**关键**：此步骤只提取元信息，不进行 OCR 或内容提取！

---

## 访问绕过方法

### 问题

直接访问小红书链接经常被封锁（404, error_code=300031）

### 解决方案

通过首页搜索结果访问，自动添加 xsec_token：

- 直接访问：`https://www.xiaohongshu.com/explore/xxx` ❌ 被封锁
- 搜索访问：`https://www.xiaohongshu.com/explore/xxx?xsec_token=xxx&xsec_source=pc_search` ✅ 成功

### URL 参数说明

- `xsec_token`: 小红书安全令牌，通过搜索结果页面自动生成
- `xsec_source`: 来源标识（如 `pc_search`）

---

## 第二步：OCR 提取（最后手段）

只有在以下情况才进入此步骤：
- 微信公众号没有该文章
- 其他文字平台也没有
- 用户明确要求从小红书提取
- 内容是小红书原创（独家图文/视频）

### 2.1 内容类型识别

| 类型 | 特征 | 提取方式 |
|------|------|----------|
| **图文笔记** | 显示 "1/N" 图片计数 | 图片 OCR |
| **视频笔记** | 有播放按钮、时长显示 | 视频字幕/描述提取 |

### 2.2 图文笔记提取

```javascript
// 提取所有图片 URL
() => {
  const images = document.querySelectorAll('img');
  const articleImages = [];
  images.forEach(img => {
    const src = img.src || img.getAttribute('data-src');
    if (src && src.includes('xhscdn.com') && src.includes('!nd_dft_wlteh_webp')) {
      articleImages.push(src);
    }
  });
  return [...new Set(articleImages)];
}
```

**OCR 流程**：
1. 下载所有图片到本地
2. 对每张图片进行 OCR 识别
3. 按图片顺序整理文字内容
4. 去除水印、表情等干扰内容

### 2.3 视频笔记提取

1. 提取视频描述文字（页面可见）
2. 如有字幕，提取字幕内容
3. 关键帧截图 + OCR（如果需要）

---

## 完整流程图

```
用户提供小红书链接
       │
       ▼
┌──────────────────┐
│ 访问小红书页面   │
│ 提取：标题、作者 │  ← 只提取元信息，不做 OCR
└──────────────────┘
       │
       ▼
┌──────────────────┐
│ 搜索文字平台     │  ← 详见 SKILL.md 搜索技巧
│ （搜狗/Google等）│
└──────────────────┘
       │
       ├── 找到 ──→ 使用文字平台提取 ──→ 完成
       │
       └── 未找到
              │
              ▼
    ┌──────────────────┐
    │ 小红书 OCR 提取  │  ← 最后手段
    │ 图片识别/视频提取│
    └──────────────────┘
              │
              ▼
            完成
```
