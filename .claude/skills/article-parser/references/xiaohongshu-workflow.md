# 小红书文章提取工作流

## 核心原则

**小红书是图片/视频平台，提取成本高。优先搜索文字平台版本。**

完整流程：
1. 访问小红书页面 → **只提取元信息**（标题、作者、发布时间）
2. 用元信息搜索文字平台（微信公众号、知乎、博客等）
3. **只有完全搜索不到**，才回到小红书使用 OCR 提取

---

## 第一步：提取元信息

### 1.1 访问小红书页面

**方法 A：通过搜索访问（推荐）**

用户提供的小红书链接可能被封锁，通过首页搜索访问更稳定：

```bash
# 步骤 1：访问小红书首页
navigate_page -> https://www.xiaohongshu.com/

# 步骤 2：使用搜索框搜索
fill -> 搜索框
value: "<用户提供的作者名或标题关键词>"

# 步骤 3：按 Enter 执行搜索
press_key -> "Enter"

# 步骤 4：从搜索结果中点击目标文章
click -> <文章标题链接>
```

**方法 B：直接访问链接**

如果用户提供的链接可以直接访问：
```bash
navigate_page -> <用户提供的小红书URL>
```

### 1.2 从页面提取元信息

访问成功后，使用 `take_snapshot` 获取页面内容，提取：

| 信息 | 页面位置 | 示例 |
|------|----------|------|
| **标题** | 文章标题区域 | "Claude Code如何让工程师效率暴涨70%？" |
| **作者** | 作者名称链接 | "sqb的Ai学习笔记" |
| **发布时间** | 时间戳 | "2025-12-23" |
| **标签** | #标签区域 | "#AI #AI编程 #Claude" |

**关键**：此步骤只提取元信息，不进行 OCR 或内容提取！

---

## 第二步：搜索文字平台

### 2.1 搜狗微信搜索（最推荐）

```bash
# 访问搜狗微信搜索
navigate_page -> https://weixin.sogou.com/

# 搜索
fill -> 搜索框
value: "<作者名> <标题关键词>"

# 执行搜索
press_key -> "Enter"
```

**检查搜索结果**：
- 公众号名称是否匹配或相似
- 标题关键词是否匹配
- 发布时间是否接近

### 2.2 Google/Bing 搜索

```
site:mp.weixin.qq.com "<作者名>" "<标题关键词>"
"<作者名>" "<标题关键词>" 公众号
"<作者名>" "<标题关键词>" 知乎
"<作者名>" "<标题关键词>" 博客
```

### 2.3 搜索优先级

| 优先级 | 搜索平台 | 说明 |
|-------|----------|------|
| 1 | 搜狗微信搜索 | 覆盖最全、更新及时 |
| 2 | Google/Bing site:mp.weixin.qq.com | 精确搜索微信文章 |
| 3 | 知乎/简书搜索 | 技术文章常有同步 |
| 4 | 个人博客/官网 | 原创作者可能有博客 |

### 2.4 搜索结果判断

**找到文字版本** → 使用该平台提取，流程结束

**判断标准**：
- 作者名匹配或高度相似
- 标题包含相同关键词
- 内容主题一致
- 发布时间接近

**完全搜索不到** → 继续第三步

---

## 第三步：小红书 OCR 提取（最后手段）

只有在以下情况才进入此步骤：
- 微信公众号没有该文章
- 其他文字平台也没有
- 用户明确要求从小红书提取
- 内容是小红书原创（独家图文/视频）

### 3.1 内容类型识别

| 类型 | 特征 | 提取方式 |
|------|------|----------|
| **图文笔记** | 显示 "1/N" 图片计数 | 图片 OCR |
| **视频笔记** | 有播放按钮、时长显示 | 视频字幕/描述提取 |

### 3.2 图文笔记提取

```javascript
// 提取所有图片 URL
() => {
  const images = document.querySelectorAll('img');
  const articleImages = [];
  images.forEach(img => {
    const src = img.src || img.getAttribute('data-src');
    if (src && src.includes('xhscdn.com') && src.includes('!nd_dft_wlteh_webp')) {
      articleImages.push(src);
    }
  });
  return [...new Set(articleImages)];
}
```

**OCR 流程**：
1. 下载所有图片到本地
2. 对每张图片进行 OCR 识别
3. 按图片顺序整理文字内容
4. 去除水印、表情等干扰内容

### 3.3 视频笔记提取

1. 提取视频描述文字（页面可见）
2. 如有字幕，提取字幕内容
3. 关键帧截图 + OCR（如果需要）

---

## 小红书访问绕过方法

### 问题

直接访问小红书链接经常被封锁（404, error_code=300031）

### 解决方案

通过首页搜索结果访问，自动添加 xsec_token：

- 直接访问：`https://www.xiaohongshu.com/explore/xxx` ❌ 被封锁
- 搜索访问：`https://www.xiaohongshu.com/explore/xxx?xsec_token=xxx&xsec_source=pc_search` ✅ 成功

### URL 参数说明

- `xsec_token`: 小红书安全令牌，通过搜索结果页面自动生成
- `xsec_source`: 来源标识（如 `pc_search`）

---

## 完整流程图

```
用户提供小红书链接
       │
       ▼
┌──────────────────┐
│ 访问小红书页面   │
│ 提取：标题、作者 │  ← 只提取元信息，不做 OCR
└──────────────────┘
       │
       ▼
┌──────────────────┐
│ 搜狗微信搜索     │
│ Google/Bing搜索  │  ← 用元信息搜索文字平台
│ 知乎/博客搜索    │
└──────────────────┘
       │
       ├── 找到 ──→ 使用文字平台提取 ──→ 完成
       │
       └── 未找到
              │
              ▼
    ┌──────────────────┐
    │ 小红书 OCR 提取  │  ← 最后手段
    │ 图片识别/视频提取│
    └──────────────────┘
              │
              ▼
            完成
```

---

## 示例

### 示例 1：找到微信版本

1. 用户提供：`https://www.xiaohongshu.com/explore/xxx`
2. 访问页面，提取：作者="sqb的Ai学习笔记"，标题="Claude Code效率暴涨70%"
3. 搜狗搜索：`sqb的Ai学习笔记 Claude Code`
4. 找到微信文章：`https://mp.weixin.qq.com/s/xxx`
5. → 使用微信提取流程，不使用小红书 OCR

### 示例 2：未找到其他版本

1. 用户提供：`https://www.xiaohongshu.com/explore/xxx`
2. 访问页面，提取：作者="某某"，标题="独家攻略"
3. 搜狗搜索：未找到
4. Google 搜索：未找到
5. → 使用小红书 OCR 提取图片内容
